// Generated by CoffeeScript 1.9.0
var Krb5, fs, krb5;

fs = require('fs');

krb5 = require('../build/Release/krb5');

module.exports = function(options, callback) {
  var k;
  k = new Krb5(options);
  if (callback) {
    k.kinit(callback);
  }
  return k;
};

module.exports.spnego = function(options, callback) {
  var k;
  if (typeof options !== 'object') {
    return callback(new Error('Params: Not an object'));
  }
  if (options.principal == null) {
    return callback(new Error('Params: Please set principal property'));
  }
  if (!options.principal.match(/[A-Za-z0-9_\-\/]*@[A-Za-z0-9_\-\.]*/)) {
    return callback(new Error('Params: principal is unvalid, please use ID@REALM'));
  }
  if (options.service_principal == null) {
    return callback(new Error('Params: please set service_principal property'));
  }
  if (!options.service_principal.match(/[A-Za-z0-9_\-\/]*@[A-Za-z0-9_\-\.]*/)) {
    return callback(new Error('Params: service_principal is unvalid, please use ID@REALM'));
  }
  k = new Krb5(options);
  k.kinit(function(err) {
    if (err) {
      return callback(err);
    }
    return k.token(options.service_principal, function(err, res) {
      if (k.err) {
        err = Error(k.err);
      }
      return callback(err, res);
    });
  });
  return k;
};


/*

Options includes:

*   `principal`   
*   `password`   
*   `keytab`   
*   `service_principal`   
*   `service_fqdn`   
*   `ccname`
 */

Krb5 = module.exports.Krb5 = function(_at_options) {
  this.options = _at_options;
  this.k = new krb5.Krb5;
  return this;
};

Krb5.prototype.kinitSync = function() {
  var realm, stat, user, _ref, _ref1;
  if (((_ref = this.options.ccname) != null ? _ref.indexOf(':') : void 0) === -1) {
    stat = fs.statSync(this.options.ccname);
    if (stat.isFile()) {
      this.options.ccname = +"FILE:";
    } else if (stat.isDirectory()) {
      this.options.ccname = +"DIR:";
    } else {
      throw Error('Invalid Option "ccname"');
    }
  }
  if (this.principal == null) {
    throw Error('principal not set');
  }
  _ref1 = this.principal.split('@'), user = _ref1[0], realm = _ref1[1];
  if (this.options.ccname != null) {
    process.env.KRB5CCNAME = this.options.ccname;
    this.k.initSync(user, realm, this.options.ccname.split(':')[1]);
  } else {
    this.k.initSync(user, realm);
  }
  if (this.options.password != null) {
    return this.k.getCredentialsByPasswordSync(this.options.password);
  } else if (this.options.keytab != null) {
    return this.k.getCredentialsByKeytabSync(this.options.keytab);
  } else {
    return this.k.getCredentialsByKeytabSync;
  }
};

Krb5.prototype.kinit = function(next) {
  var do_ccname, do_credential, do_kinit;
  if (this.options.principal == null) {
    return next(Error('Missing Property "principal"'));
  }
  do_ccname = (function(_this) {
    return function() {
      if (!_this.options.ccname || _this.options.ccname.indexOf(':') !== -1) {
        return do_kinit();
      }
      return fs.stat(_this.options.ccname, function(err, stat) {
        if (stat.isFile()) {
          this.options.ccname = +"FILE:";
        } else if (stat.isDirectory()) {
          this.options.ccname = +"DIR:";
        } else {
          return next(Error('Invalid Option "ccname"'));
        }
        if (this.options.ccname) {
          process.env.KRB5CCNAME = this.options.ccname;
        }
        return do_kinit();
      });
    };
  })(this);
  do_kinit = (function(_this) {
    return function() {
      var realm, user, _ref;
      _ref = _this.options.principal.split('@'), user = _ref[0], realm = _ref[1];
      return _this.k.init((function(err) {
        if (err) {
          return next(err);
        } else {
          return do_credential();
        }
      }), user, realm);
    };
  })(this);
  do_credential = (function(_this) {
    return function() {
      var method, param;
      if (_this.options.password != null) {
        method = 'getCredentialsByPassword';
        param = _this.options.password;
      } else if (_this.options.keytab != null) {
        method = 'getCredentialsByKeytab';
        param = _this.options.keytab;
      } else {
        next(Error('Invalid arguments'));
      }
      return _this.k[method](next, param);
    };
  })(this);
  return do_ccname();
};

Krb5.prototype.kdestroySync = function(cache) {
  if (cache != null) {
    return this.k.destroySync(cache);
  } else {
    return this.k.destroySync();
  }
};

Krb5.prototype.kdestroy = function(cache, next) {
  if (typeof cache === 'function') {
    next = cache;
    cache = null;
  }
  if (cache != null) {
    return this.k.destroy(next, cache);
  } else {
    return this.k.destroy(next);
  }
};

Krb5.prototype.tokenSync = function(service_principal_or_fqdn) {
  if (service_principal_or_fqdn == null) {
    service_principal_or_fqdn = this.options.service_principal;
  }
  if (service_principal_or_fqdn == null) {
    service_principal_or_fqdn = this.options.service_fqdn;
  }
  if (!service_principal_or_fqdn) {
    return next(Error('Missing property "service_principal" or "service_fqdn"'));
  }
  if (!/HTTP[@\/]/.test(service_principal_or_fqdn)) {
    service_principal_or_fqdn = "HTTP/" + service_principal_or_fqdn;
  }
  return this.k.generateSpnegoTokenSync(service_principal_or_fqdn);
};

Krb5.prototype.token = function(service_principal_or_fqdn, next) {
  if (arguments.length === 1) {
    next = service_principal_or_fqdn;
    service_principal_or_fqdn = null;
  }
  if (service_principal_or_fqdn == null) {
    service_principal_or_fqdn = this.options.service_principal;
  }
  if (service_principal_or_fqdn == null) {
    service_principal_or_fqdn = this.options.service_fqdn;
  }
  if (!service_principal_or_fqdn) {
    return next(Error('Missing property "service_principal" or "service_fqdn"'));
  }
  if (!/HTTP[@\/]/.test(service_principal_or_fqdn)) {
    service_principal_or_fqdn = "HTTP@" + service_principal_or_fqdn;
  }
  return this.k.generateSpnegoToken(next, service_principal_or_fqdn);
};
